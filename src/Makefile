# Makefile for project 1
#
# CMSC 22600 --- Compilers for Computer Languages
# Autumn 2021
# University of Chicago
#
# COPYRIGHT (c) 2021 John Reppy (http://cs.uchicago.edu/~jhr)
# All rights reserved.
#
# targets:
#	make mlc	-- Build ML Lite compiler
#	make clean	-- remove intermediate files
#

SHELL =         /bin/sh

# we assume that sml (and thus ml-build is in the path)
#
ML_BUILD =		ml-build
ML_BUILD_FLAGS =
ML_MAKEDEPEND =		ml-makedepend
ML_MAKEDEPEND_FLAGS =

HEAP_SUFFIX =	$(shell sml @SMLsuffix)

COMPILER =	mlc
RUNTIME =	mll-rt.o

BIN_DIR =	../bin

CM_FILES =	$(wildcard */sources.cm)
HEAP =		$(COMPILER).$(HEAP_SUFFIX)
TARGET =	$(BIN_DIR)/$(HEAP)
ROOT_CM =	driver/sources.cm

.PHONY:		all
all:		$(TARGET) $(RUNTIME)

# build rule for compiler
$(TARGET):	.depend
	$(ML_BUILD) driver/sources.cm Main.main $(COMPILER)
	mv $(HEAP) $(TARGET)

# build rule for the runtime system
$(RUNTIME):	$(wildcard runtime/*.h) $(wildcard runtime/*.c)
	(cd runtime; $(MAKE))

#
# Dependency file rules
#
.depend:        $(CM_FILES)
	touch .depend
	$(ML_MAKEDEPEND) $(ML_MAKEDEPEND_FLAGS) -n -f .depend $(ROOT_CM) $(HEAP_IMAGE) || rm -f .depend

ifneq ($(MAKECMDGOALS),clean)
sinclude .depend
endif

# remove generated files (including the files generated by ml-antlr and ml-ulex)
#
.PHONY:		clean
clean:
		(cd runtime; make clean)
		rm -f $(TARGET) .depend
		rm -rf .cm */.cm
		rm -f parser/mll.lex.sml
		rm -f parser/mll.grm.sml
